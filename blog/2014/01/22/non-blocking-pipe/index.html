
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Non blocking pipe - Yizhe Tang</title>
	<meta name="author" content="Yizhe Tang">

	
	<meta name="description" content="Non Blocking Pipe Met a problem of linux pipe from daily work, finally got me to write a small tool to get rid of it. Worth to note. Motivation I& &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feedpress.me/typd" rel="alternate" title="Yizhe Tang" type="application/atom+xml">
	
	<link rel="canonical" href="http://typd.github.io/blog/2014/01/22/non-blocking-pipe/">
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/typd.css" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
    <!-- use external jquery is faster -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- <script src="/javascripts/jquery-1.11.3.min.js"></script> -->
    
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-44831634-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
    
        <img src="/images/la-small2.png" alt="Profile Picture" style="width: 160px;" />
    
</div>
<hgroup>
  <h1><a href="/">Yizhe Tang</a></h1>
  
  
  
    <span style="color:white">thinking and writing</span>
  
</hgroup>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/blog/archives">archives</a></li>
  <li><a href="/pages/toolbelt">toolbelt</a></li>
  <li><a href="/pages/picks">picks</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		<a class="douban" href="https://www.douban.com/people/typd" title="Douban">Douban</a>
		
		
		<a class="github" href="https://github.com/typd" title="GitHub">GitHub</a>
		
		
		<a class="coderwall" href="https://coderwall.com/typd" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		<a class="rss" href="http://feedpress.me/typd" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="title" itemprop="name">Non Blocking Pipe</h1>
	<div class="entry-content" itemprop="articleBody"><p>Met a problem of linux pipe from daily work, finally got me to write a small tool to get rid of it. Worth to note.</p>

<h1>Motivation</h1>

<p>I&rsquo;ve built a central logging system based on logstash. It looks like this, basically,</p>

<br/>


<p><img src="/images/posts/2014-01-22/1.png" alt="" /></p>

<br/>


<p>Then every program use logstash as a shipper to redirect its log into the broker, which is a redis as message queue. As this <a href="http://adam.heroku.com/past/2011/4/1/logs_are_streams_not_files/">blog</a> recommended, treatting log as stream rather than files, linux pipe make it possible to guide the stream to anywhere easily.</p>

<pre><code>application | java -jar logstash.jar agent -f logstash.conf
</code></pre>

<p>The problem occurs when the redis was accidently down, causes</p>

<ul>
<li>Logstash blocked, which is a designed behavior of <a href="http://logstash.net/docs/1.3.3/life-of-an-event">logstash</a>. It says &ldquo;dropping messages or unlimited queue lenght are both undesirable behavior&rdquo;, so simply leaves no option and get it blocked.</li>
<li>Then caused upstream application blocked, too! This is done by OS after the pipe buffer is filled up. This is a more serious problem as it&rsquo;s not easy to change OS default behavior.</li>
</ul>


<!-- more -->


<h1>Solution?</h1>

<p>Two possible solutions</p>

<ul>
<li>Introduce a log file, start logstash as a independent service to monitor it. This is the opposed way of the above blog recommended. This brings unnecessary disk IO, and you may need other things to avoid the log file getting too big, etc.</li>
<li>Make the pipe non-blocking. But how?</li>
</ul>


<h1>How</h1>

<p>After investigation, logstash doesn&rsquo;t provide non-blocking option, described as above, although it should be easy to do. Why not write one? Here&rsquo;s the result,</p>

<pre><code>application | non_blocking_pipe java -jar logstash.jar agent -f logstash.conf
</code></pre>

<p>&ldquo;non_blocking_pipe&rdquo; is a middleware to read input from upstream, and send to downstream. It uses a fixed size internal queue. If downstream becomes blocked or slower than upstream, just drop the messages and remain reading inputs. A sidenote, why not do &ldquo;application | non_blocking_pipe | downstream&rdquo;, it&rsquo;s because the middle component has to own the downstream as a subprocess, in order to know if it&rsquo;s blocked.</p>

<p><a href="https://github.com/typd/non-blocking-pipe">Code available here</a>.</p>
</div>

</article>


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2016 - Yizhe Tang
  <br/>
  Powered by <a href="http://octopress.org">Octopress</a> - Design by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
</p>

</footer>
			<!-- NOTE disqus is not accessable -->
<!-- 

 -->








<!-- Clicky asynchronous tracking code -->
<a title="Web Analytics" href="http://clicky.com/100664578"><img width="0" height="0" alt="Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script type="text/javascript">
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(100664578);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
</script>
<noscript><p><img alt="Clicky" width="0" height="0" src="//in.getclicky.com/100664578ns.gif" /></p></noscript>



		</div>
	</div>
</body>
</html>
